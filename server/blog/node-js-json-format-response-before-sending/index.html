<!DOCTYPE html>
<html>
<head>
  <title>Node.js: JSON Format Response Before Sending | WegnerDesign</title>
  <link rel="stylesheet" type="text/css" href="/stylesheets/blog.css" />
  <link rel="stylesheet" type="text/css" href="/stylesheets/pygment_trac.css" />
  <link rel="stylesheet" type="text/css" href="/fonts/stylesheet.css" />
  <script type="text/javascript">
      var _gaq = _gaq || [];
      _gaq.push(['_setAccount', 'UA-19623283-1']);
      _gaq.push(['_setDomainName', 'wegnerdesign.com']);
      _gaq.push(['_trackPageview']);

      (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
      })();
  </script>
  <script type="text/javascript">
    function go() {
      var tweetLink = document.getElementsByClassName("tweet")[0].getElementsByTagName("a")[0];

      var url = encodeURIComponent("http://www.wegnerdesign.com/blog/node-js-json-format-response-before-sending");
      var name = encodeURIComponent("Node.js: JSON Format Response Before Sending via #WegnerDesign")

      tweetLink.href = "https://twitter.com/intent/tweet?url="+url+"&text="+name;
    }
  </script>
  <meta property="og:type" content="article" />
  <meta property="og:title" content="" />
  <meta property="og:url" content="" />
  <meta property="og:locale" content="en_US" />
  <meta property="og:site_name" content="WegnerDesign" />
</head>
<body onload="go();">
  <div id="socialColumn">
    <div class='tweet'><a target="_blank" href="#"></a></div>
  </div>
  <div id="metaColumn">
    <div id="logo">
      <img src="/images/logo.png" />
    </div>
    <div id="footercontrols">
      <div id="index"><a href="/blog"><img src="/images/index.png" /></a></div><!--
     --><div id="rss"><a href="/feed.xml"><img src="/images/rss.png" /></a></div></div>
    </div>
  </div>
  <div id="post">
    <h2><span class='title'>Node.js: JSON Format Response Before Sending</span><span class="date">30 April 2012</span></h2>
    <div id="body">Chances are that if you're reading this blog, you're probably doing something in Node.js, or at least javascript. Furthermore, chances are that if you are doing something in Node.js, you like to speak <a title="JSON" href="http://www.json.org/">JSON</a>.  JSON is the universal language for speaking between two systems that don't necessarily speak the same language.  Originally the standard for this sort of exchange was XML, but JSON is becoming the preferred format due to its support for more specific types such as arrays.  If you're not already using JSON internally, it's probably a good idea to start, as many of the big-name APIs are defaulting to JSON.<!--more-->

Trying to keep to that standard, I find myself writing the same lines over and over to encode my objects in JSON before returning them (this is generally returning to an API call).  I wrote a quick little script to automatically detect if I'm trying to respond with an object.  Here goes:
[code lang="lang-js"]//This probably goes somewhere else, but for testing purposes...
var http = require('http');

//Scope this however is ideal for your environment
var hold = http.ServerResponse.prototype.end;
http.ServerResponse.prototype.end = function() {
if(typeof(arguments[0]) === "object") {
arguments[0] = JSON.stringify(arguments[0]);
}

hold.apply(this, arguments);
};

http.createServer(function(req, res) {
//And build your objects however you like. No special format - just your data.
var dat = {
a: "This",
b: "is",
c: "some",
d: "data!"
};

res.end(dat);
}).listen(1234);[/code]

Pretty simple little addition. As I mentioned in the code, you may want to scope the `hold` variable a little different, depending on your environment. Also - <strong>this is important</strong> - this will NOT work if you are using res.write(). This generally isn't the case if you are formatting in JSON, because it's hard to chunk an object, but if you are fancy like that you will need to make some modifications. It should be simple enough to override the res.write() function in a similar way as I did with res.end().

Additionally, a system like this can be used for pretty much any pre-write hook.  It's not always a good idea to override the pre-defined functions in Node.js (it's hard to maintain), but occasionallyÂ that makes the most sense.  If you have different functionality you'd like to add, just replace the http.ServerResponse.prototype.end portion with whatever you need to do.
</div>
    <div id="disqus_thread" style="width: 75%; margin-top: 50px;"></div>
    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'wegnerdesign'; // required: replace example with your forum shortname
        var disqus_identifier = '';

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
  </div>
  <div id="footer"></div>
</body>
</html>